<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>blog.mo-fu.org - SqaleからAmazonS3にDBをバックアップする</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
    <link href="/stylesheets/normalize.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/blog.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/blog-old-ie.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/syntax.css" rel="stylesheet" type="text/css" />
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>
    
    <div id="main" role="main">
      <p>Sqale で運用しているアプリケーションのDBのdumpファイルを
S3のバケットに保存する方法です。</p>

<h2 id="はじめに">はじめに</h2>

<p>AWSのAccess Keyを管理画面で閲覧してメモしておいてください。
Security Credentials を選択、Access Keys をクリックするとAccess Key IDが表示されます。</p>

<p>こちらにアクセスキーに関する説明があります。</p>

<ul>
<li><a href="http://blogs.aws.amazon.com/security/post/Tx1R9KDN9ISZ0HF/Where-s-my-secret-access-key">http://blogs.aws.amazon.com/security/post/Tx1R9KDN9ISZ0HF/Where-s-my-secret-access-key</a></li>
</ul>

<h2 id="s3にバケット作成する">S3にバケット作成する</h2>

<p>gateway.sqale.jp にsshログイン。</p>
<pre><code class="highlight plaintext">ssh gateway.sqale.jp -p 2222
</code></pre>

<p>以下のコマンドを入力したあと、AWSのアクセスキーとシークレットキー入力します。</p>
<pre><code class="highlight plaintext">s3cmd --configure

</code></pre>

<p><code>s3cmd mb</code> コマンドでS3にバケットを作成します。</p>
<pre><code class="highlight plaintext">s3cmd mb s3://sampleapp-backup
</code></pre>

<p>以下のようにメッセージが出力されれば、バケットの作成が完了です。</p>
<pre><code class="highlight plaintext">Bucket 's3://sampleapp-backup/' created
</code></pre>

<h2 id="s3にdumpファイルをアップロードする">S3にdumpファイルをアップロードする</h2>

<p><code>s3cmd put</code> コマンドでdumpファイルをアップロードします。</p>
<pre><code class="highlight plaintext">s3cmd put 20140105-sampleapp-mysql.dump s3://sampleapp-backup/20140105-sampleapp-mysql.dump
</code></pre>

<h2 id="定期的にdumpファイルをs3に保存する">定期的にdumpファイルをS3に保存する</h2>

<p>以下のようにrake task を作成してcronで設定すれば、
定期的にdumpファイルを保存することができます。</p>
<pre><code class="highlight ruby"><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"mysql dump: db backup to Amazon S3"</span>

  <span class="n">task</span> <span class="ss">:backup</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="nb">system</span> <span class="s2">"mysqldump -u </span><span class="si">#{</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'SQALE_USERNAME'</span><span class="p">]</span><span class="si">}</span><span class="s2"> -h </span><span class="si">#{</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'SQALE_HOST'</span><span class="p">]</span><span class="si">}</span><span class="s2"> -p </span><span class="si">#{</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'SQALE_DATABASE'</span><span class="p">]</span><span class="si">}</span><span class="s2"> --password=</span><span class="si">#{</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'SQALE_PASSWORD'</span><span class="p">]</span><span class="si">}</span><span class="s2"> &gt; ../tmp/</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">)</span><span class="si">}</span><span class="s2">-sampleapp-mysql.dump"</span>
    <span class="nb">system</span> <span class="s2">"s3cmd put ../tmp/</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="s1">'%Y%m%d'</span><span class="p">)</span><span class="si">}</span><span class="s2">-sampleapp-mysql.dump s3://sampleapp-backup/</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">year</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">month</span><span class="si">}</span><span class="s2">/"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<h2 id="参考url">参考URL</h2>

<ul>
<li><a href="http://blogs.aws.amazon.com/security/post/Tx1R9KDN9ISZ0HF/Where-s-my-secret-access-key">http://blogs.aws.amazon.com/security/post/Tx1R9KDN9ISZ0HF/Where-s-my-secret-access-key</a></li>
<li><a href="https://sqale.jp/support/manual/db-backup-restore">https://sqale.jp/support/manual/db-backup-restore</a></li>
</ul>

    </div>
    
    <aside>
      <h2>Recent Articles</h2>
      <ol>
          <li><a href="/2014/01/09/install-ggplot2.html">ggplot2をインストールして使うまで</a> <span>Jan  9</span></li>
          <li><a href="/2014/01/05/backup-to-amazon-s3.html">SqaleからAmazonS3にDBをバックアップする</a> <span>Jan  5</span></li>
          <li><a href="/2013/12/24/how-to-use-git-on-heteml.html">hetemlレンタルサーバーでgitを使う</a> <span>Dec 24</span></li>
          <li><a href="/2013/11/18/about-testing-for-private-method.html">プライベートメソッドのテストについて</a> <span>Nov 18</span></li>
          <li><a href="/2013/09/29/install-mac-vim74.html">install-mac-vim74</a> <span>Sep 29</span></li>
          <li><a href="/2013/09/15/i-change-my-blog-name.html">Change my blog's url</a> <span>Sep 15</span></li>
          <li><a href="/2012/12/24/fuelphp-advent-calendar-2012.html">FuelPHPで簡単なWebアプリケーションを作ってみる</a> <span>Dec 24</span></li>
          <li><a href="/2012/11/19/startup-rails4.html">rails4(edge)を動かしてみた。</a> <span>Nov 19</span></li>
          <li><a href="/2012/11/16/ppb-lightningtalk-2.html">社内LT大会第二回</a> <span>Nov 16</span></li>
          <li><a href="/2012/11/01/nebel-siteでブログはじめました.html">nebelでブログはじめました</a> <span>Nov  1</span></li>
      </ol>

      <h2>Tags</h2>
      <ol>
          <li><a href="/tags/rails4.html">rails4 (1)</a></li>
          <li><a href="/tags/fuelphp.html">fuelphp (1)</a></li>
          <li><a href="/tags/php.html">php (1)</a></li>
          <li><a href="/tags/vim.html">vim (1)</a></li>
          <li><a href="/tags/testing.html">testing (1)</a></li>
          <li><a href="/tags/git.html">git (1)</a></li>
          <li><a href="/tags/heteml.html">heteml (1)</a></li>
          <li><a href="/tags/s3.html">s3 (1)</a></li>
          <li><a href="/tags/sqale.html">sqale (1)</a></li>
          <li><a href="/tags/r.html">R (1)</a></li>
          <li><a href="/tags/ggplot2.html">ggplot2 (1)</a></li>
      </ol>

      <h2>By Year</h2>
      <ol>
          <li><a href="/2014.html">2014 (2)</a></li>
          <li><a href="/2013.html">2013 (4)</a></li>
          <li><a href="/2012.html">2012 (4)</a></li>
      </ol>
    </aside>
  </body>
</html>
