<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Blog Title - SqaleからAmazonS3にDBをバックアップする</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>
    
    <div id="main" role="main">
      <p>Sqale で運用しているアプリケーションのDBのdumpファイルを
S3のバケットに保存する方法です。</p>

<h2 id="section">はじめに</h2>

<p>AWSのAccess Keyを管理画面で閲覧してメモしておいてください。
Security Credentials を選択、Access Keys をクリックするとAccess Key IDが表示されます。</p>

<p>こちらにアクセスキーに関する説明があります。</p>

<ul>
  <li>http://blogs.aws.amazon.com/security/post/Tx1R9KDN9ISZ0HF/Where-s-my-secret-access-key</li>
</ul>

<h2 id="s3">S3にバケット作成する</h2>

<p>gateway.sqale.jp にsshログイン。</p>

<p><code>
ssh gateway.sqale.jp -p 2222
</code></p>

<p>以下のコマンドを入力したあと、AWSのアクセスキーとシークレットキー入力します。</p>

<p>```
s3cmd –configure</p>

<p>```</p>

<p><code>s3cmd mb</code> コマンドでS3にバケットを作成します。</p>

<p><code>
s3cmd mb s3://sampleapp-backup
</code></p>

<p>以下のようにメッセージが出力されれば、バケットの作成が完了です。</p>

<p><code>
Bucket 's3://sampleapp-backup/' created
</code></p>

<h2 id="s3dump">S3にdumpファイルをアップロードする</h2>
<p><code>s3cmd put</code> コマンドでdumpファイルをアップロードします。</p>

<p><code>
s3cmd put 20140105-sampleapp-mysql.dump s3://sampleapp-backup/20140105-sampleapp-mysql.dump
</code></p>

<h2 id="dumps3">定期的にdumpファイルをS3に保存する</h2>
<p>以下のようにrake task を作成してcronで設定すれば、
定期的にdumpファイルを保存することができます。</p>

<p>```ruby
namespace :db do
  desc "mysql dump: db backup to Amazon S3"</p>

<p>task :backup =&gt; :environment do
    system "mysqldump -u #{ENV['SQALE_USERNAME']} -h #{ENV['SQALE_HOST']} -p #{ENV['SQALE_DATABASE']} –password=#{ENV['SQALE_PASSWORD']} &gt; ../tmp/#{Time.now.strftime('%Y%m%d')}-sampleapp-mysql.dump"
    system "s3cmd put ../tmp/#{Time.now.strftime('%Y%m%d')}-sampleapp-mysql.dump s3://sampleapp-backup/#{Time.now.year}/#{Time.now.month}/"
  end
end
```</p>

<h2 id="url">参考URL</h2>
<ul>
  <li>http://blogs.aws.amazon.com/security/post/Tx1R9KDN9ISZ0HF/Where-s-my-secret-access-key</li>
  <li>https://sqale.jp/support/manual/db-backup-restore</li>
</ul>

    </div>
    
    <aside>
      <h2>Recent Articles</h2>
      <ol>
          <li><a href="/2014/01/09/install-ggplot2.html">ggplot2をインストールして使うまで</a> <span>Jan  9</span></li>
          <li><a href="/2014/01/05/backup-to-amazon-s3.html">SqaleからAmazonS3にDBをバックアップする</a> <span>Jan  5</span></li>
          <li><a href="/2013/12/24/how-to-use-git-on-heteml.html">hetemlレンタルサーバーでgitを使う</a> <span>Dec 24</span></li>
          <li><a href="/2013/11/18/about-testing-for-private-method.html">プライベートメソッドのテストについて</a> <span>Nov 18</span></li>
          <li><a href="/2013/09/29/install-mac-vim74.html">install-mac-vim74</a> <span>Sep 29</span></li>
          <li><a href="/2013/09/15/i-change-my-blog-name.html">Change my blog's url</a> <span>Sep 15</span></li>
          <li><a href="/2012/12/24/fuelphp-advent-calendar-2012.html">FuelPHPで簡単なWebアプリケーションを作ってみる</a> <span>Dec 24</span></li>
          <li><a href="/2012/11/19/startup-rails4.html">rails4(edge)を動かしてみた。</a> <span>Nov 19</span></li>
          <li><a href="/2012/11/16/ppb-lightningtalk-2.html">社内LT大会第二回</a> <span>Nov 16</span></li>
          <li><a href="/2012/11/01/nebel-siteでブログはじめました.html">nebelでブログはじめました</a> <span>Nov  1</span></li>
      </ol>

      <h2>Tags</h2>
      <ol>
      </ol>

      <h2>By Year</h2>
      <ol>
          <li><a href="/2014.html">2014 (2)</a></li>
          <li><a href="/2013.html">2013 (4)</a></li>
          <li><a href="/2012.html">2012 (4)</a></li>
      </ol>
    </aside>
  </body>
</html>
